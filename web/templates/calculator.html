<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flask Tutorial</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/js-yaml/dist/js-yaml.min.js"></script>
  <style>
    .error {
      color: red;
      font-size: 0.9em;
    }
  </style>
</head>

<body>
  {% include 'navbar.html' %}

  <div class="container">
    <h1 class="mb-4 mt-4">Calculator</h1>

    <form id="calculator" action="/calculator" method="post" class="mb-5">

      <div class="mb-3">
        <label for="budget" class="form-label">Budget</label>
        <input type="number" class="form-control" id="budget" name="budget" placeholder="2500">
      </div>

      <div class="mb-3">
        <label for="menu" class="form-label">Paste menu file</label>
        <textarea class="form-control" id="menu" name="menu" rows="15"
          placeholder="{% include 'yaml_placeholder.yaml' %}"></textarea>
        <div id="errorMessage" class="error mt-2"></div>
      </div>

      <button type="submit" id="submitButton" class="btn btn-primary" disabled>Calculate</button>

    </form>

    {% if result is defined and result is not none %}
    {% include 'result_table.html' %}
    {% elif result is defined and result is none %}
    <div class="alert alert-danger d-flex align-items-center" role="alert">
      <div>
        There is no solution!
      </div>
    </div>
    {% endif %}

    <script>
      const budget = document.getElementById('budget');
      const menu = document.getElementById('menu');
      const errorMessage = document.getElementById('errorMessage');
      const submitButton = document.getElementById('submitButton');

      function validateYAML(content) {
        try {
          jsyaml.load(content);
          errorMessage.textContent = '';
          submitButton.disabled = false;
        } catch (error) {
          errorMessage.textContent = `Syntax Error: ${error.message}`;
          submitButton.disabled = true;
        }
      }

      function saveData(budget_value, menu_value){
        localStorage.setItem("budget", budget_value);
        localStorage.setItem("menu", menu_value);
      }

      function getData(){
        try{
          var budget_value = localStorage.getItem("budget");
          var menu_value = localStorage.getItem("menu");

          budget.value = budget_value;
          menu.value = menu_value;
        } catch(error) {
          budget.value = 0;
          menu.value = "";
        }
      }

      menu.addEventListener('input', () => {
        const content = menu.value;
        validateYAML(content);
      });

      submitButton.addEventListener('click', () => {
        const budget_value = budget.value;
        const menu_value = menu.value;

        saveData(budget_value, menu_value);
      });

      getData();
      validateYAML(menu.value);

    </script>
</body>

</html>